<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>뇌파 데이터 (0-250s) 평균 분석기 및 XLSX 출력</title>
    <!-- Tailwind CSS (Aesthetics) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .card { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .table-responsive { overflow-x: auto; }
        th, td { white-space: nowrap; padding: 12px 16px; text-align: left; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-extrabold text-blue-800 tracking-tight">
                BrainLink EEG 데이터 평균 분석 및 XLSX 출력
            </h1>
            <p class="mt-2 text-gray-600">파일을 업로드하면 태그(Tag)별 250초까지의 평균값을 계산하고, 결과 XLSX 파일을 다운로드합니다.</p>
        </header>

        <!-- 파일 업로드 및 컨트롤 섹션 -->
        <div class="bg-white p-6 md:p-8 rounded-xl card mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">1. 데이터 파일 업로드 및 분석</h2>
            <div class="flex flex-col md:flex-row items-stretch md:items-center space-y-4 md:space-y-0 md:space-x-4">
                <label for="eegFileInput" class="flex-grow">
                    <input type="file" id="eegFileInput" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" class="w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-50 file:text-blue-700
                        hover:file:bg-blue-100"
                        onchange="processFile()">
                </label>
                <!-- 다운로드 버튼: 분석이 완료된 후 XLSX 파일로 출력하는 기능 -->
                <button id="downloadBtn" onclick="downloadResult()" 
                        class="px-6 py-2 bg-green-500 text-white font-semibold rounded-full shadow-md hover:bg-green-600 transition duration-150 ease-in-out disabled:opacity-50"
                        disabled>
                    결과 XLSX 파일 다운로드
                </button>
            </div>
            <p id="statusMessage" class="mt-4 text-sm text-gray-500">
                CSV 또는 XLSX 파일을 선택해주세요. 파일 선택 즉시 분석이 시작되며, 완료 후 다운로드 버튼이 활성화됩니다.
            </p>
        </div>

        <!-- 결과 표시 섹션 -->
        <div class="bg-white p-6 md:p-8 rounded-xl card">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">2. 분석 결과 미리보기 (Time ≤ 250s)</h2>
            <div id="resultsContainer" class="table-responsive">
                <!-- 결과 테이블이 여기에 삽입됩니다 -->
                <p class="text-center text-gray-400 py-10">업로드된 파일의 분석 결과가 여기에 표시됩니다.</p>
            </div>
        </div>
    </div>

    <!-- SheetJS CDN (for reading and writing Excel/CSV files) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
        // 전역 변수로 최종 결과를 저장하여 다운로드 시 사용
        let finalResultData = null;
        let finalResultHeaders = null;

        /**
         * 오류/상태 메시지를 표시하는 함수
         * @param {string} message - 표시할 메시지
         * @param {boolean} isError - 오류 메시지 여부 (true면 빨간색)
         */
        function updateStatus(message, isError = false) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `mt-4 text-sm ${isError ? 'text-red-600 font-bold' : 'text-gray-500'}`;
        }

        /**
         * 사용자가 업로드한 파일을 읽고 처리하는 메인 함수
         */
        function processFile() {
            const fileInput = document.getElementById('eegFileInput');
            const file = fileInput.files[0];
            const downloadBtn = document.getElementById('downloadBtn');
            downloadBtn.disabled = true;
            finalResultData = null;
            
            if (!file) {
                updateStatus("파일을 선택해주세요.", true);
                return;
            }

            updateStatus(`[${file.name}] 파일 로드 및 분석 중...`);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 첫 번째 시트를 사용합니다. 
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // 시트 데이터를 JSON 배열로 변환
                    const rawData = XLSX.utils.sheet_to_json(worksheet);

                    if (rawData.length === 0) {
                        updateStatus("파일에 데이터가 없습니다.", true);
                        return;
                    }

                    // 분석 로직 실행
                    const analysisResult = analyzeEegData(rawData);
                    
                    // 결과 표시 및 다운로드 준비
                    displayResults(analysisResult.data, analysisResult.headers);
                    finalResultData = analysisResult.data;
                    finalResultHeaders = analysisResult.headers;
                    
                    downloadBtn.disabled = false;
                    updateStatus("분석이 완료되었습니다. 화면에서 결과를 확인하고 '결과 XLSX 파일 다운로드' 버튼을 사용하세요.");

                } catch (error) {
                    console.error("파일 처리 오류:", error);
                    updateStatus(`오류 발생: 파일을 읽거나 분석하는 데 문제가 생겼습니다. (${error.message})`, true);
                    downloadBtn.disabled = true;
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        /**
         * EEG 데이터 분석 핵심 로직 (필터링, 그룹화, 평균 계산)
         * @param {Array<Object>} rawData - 원본 데이터 JSON 배열
         * @returns {Object} { data: Array, headers: Array }
         */
        function analyzeEegData(rawData) {
            const timeCol = 'Time (s)';
            const tagCol = 'Tag/备注';

            // 필수 컬럼 확인
            if (!rawData[0].hasOwnProperty(timeCol) || !rawData[0].hasOwnProperty(tagCol)) {
                throw new Error(`필수 컬럼 ('${timeCol}', '${tagCol}') 중 일부가 누락되었습니다.`);
            }

            // 1. 250초 이하 데이터 필터링
            const filteredData = rawData.filter(row => {
                const timeValue = parseFloat(row[timeCol]);
                return !isNaN(timeValue) && timeValue <= 250;
            });

            if (filteredData.length === 0) {
                 throw new Error("250초 이하의 데이터가 없어 분석을 진행할 수 없습니다.");
            }

            // 2. 측정 항목 컬럼 식별
            const excludedCols = [timeCol, tagCol, 'Date/日期', 'Time-set/时间集合', 'Session Date', 'Session Tag'];
            const metricCols = Object.keys(filteredData[0]).filter(col => 
                !excludedCols.includes(col) && !isNaN(parseFloat(filteredData[0][col]))
            );
            
            if (metricCols.length === 0) {
                 throw new Error("측정 항목(Attention, Delta 등) 컬럼을 찾을 수 없습니다. 파일 형식을 확인해주세요.");
            }

            // 3. 태그별 합계 및 카운트 계산
            const tagStats = {};
            
            filteredData.forEach(row => {
                const tag = row[tagCol] || 'No Tag (태그 없음)';
                
                if (!tagStats[tag]) {
                    tagStats[tag] = { count: 0, sum: {} };
                    metricCols.forEach(col => tagStats[tag].sum[col] = 0);
                }
                
                tagStats[tag].count++;
                metricCols.forEach(col => {
                    const value = parseFloat(row[col]);
                    if (!isNaN(value)) {
                        tagStats[tag].sum[col] += value;
                    }
                });
            });

            // 4. 태그별 최종 평균 계산 및 결과 배열 생성
            const finalAverages = [];
            let totalAverageSum = metricCols.reduce((acc, col) => ({ ...acc, [col]: 0 }), {});
            let tagCount = 0;

            for (const tag in tagStats) {
                const stats = tagStats[tag];
                const avgRow = { '태그 (Tag)': tag };
                tagCount++;

                metricCols.forEach(col => {
                    const avg = stats.count > 0 ? stats.sum[col] / stats.count : 0;
                    avgRow[col] = avg;
                    totalAverageSum[col] += avg;
                });
                finalAverages.push(avgRow);
            }

            // 5. 종합 평균 계산
            const overallAverageRow = { '태그 (Tag)': '250초 평균의 평균' };
            metricCols.forEach(col => {
                overallAverageRow[col] = tagCount > 0 ? totalAverageSum[col] / tagCount : 0;
            });
            finalAverages.push(overallAverageRow);

            const headers = ['태그 (Tag)', ...metricCols];

            return { data: finalAverages, headers: headers };
        }

        /**
         * 분석 결과를 HTML 테이블로 렌더링
         * @param {Array<Object>} data - 결과 데이터 배열
         * @param {Array<string>} headers - 테이블 헤더 배열
         */
        function displayResults(data, headers) {
            const container = document.getElementById('resultsContainer');
            if (data.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 py-10">결과 데이터가 없습니다.</p>';
                return;
            }

            let html = '<table class="min-w-full bg-white rounded-lg overflow-hidden">';
            
            // 헤더 생성
            html += '<thead><tr class="bg-blue-500 text-white">';
            headers.forEach(header => {
                html += `<th class="px-4 py-3 font-semibold text-sm uppercase tracking-wider">${header.replace('/', ' /<br>')}</th>`;
            });
            html += '</tr></thead>';

            // 바디 생성
            html += '<tbody>';
            data.forEach((row, index) => {
                // 마지막 행 (종합 평균)은 강조 스타일 적용
                const isOverallAvg = index === data.length - 1;
                const rowClass = isOverallAvg ? 'bg-yellow-100 font-bold text-gray-800 border-t-4 border-yellow-500' : 'border-b hover:bg-gray-50';
                
                html += `<tr class="${rowClass}">`;
                headers.forEach(header => {
                    let cellValue = row[header];
                    // 태그 컬럼은 텍스트 그대로, 측정 항목은 소수점 2자리로 표시
                    if (header !== '태그 (Tag)' && typeof cellValue === 'number') {
                        cellValue = cellValue.toFixed(2);
                    }
                    html += `<td class="text-sm">${cellValue}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody>';
            
            html += '</table>';
            
            container.innerHTML = html;
        }

        /**
         * 분석 결과를 XLSX 파일로 다운로드
         */
        function downloadResult() {
            if (!finalResultData || !finalResultHeaders) {
                updateStatus("다운로드할 분석 결과가 없습니다. 먼저 파일을 업로드하고 분석해주세요.", true);
                return;
            }

            try {
                // XLSX 라이브러리를 사용하여 시트 생성
                const ws = XLSX.utils.json_to_sheet(finalResultData, { header: finalResultHeaders });
                const wb = XLSX.utils.book_new();
                // 시트 이름을 '250s_Averages_Result'로 지정
                XLSX.utils.book_append_sheet(wb, ws, "250s_Averages_Result");
                
                // 파일 다운로드
                const fileName = "Brainlink_250s_Averages_Result.xlsx";
                XLSX.writeFile(wb, fileName);
                
                updateStatus(`결과 파일 [${fileName}] 다운로드가 시작되었습니다.`, false);
            } catch (error) {
                console.error("다운로드 오류:", error);
                updateStatus(`다운로드 중 오류 발생: ${error.message}`, true);
            }
        }
    </script>
</body>
</html>
