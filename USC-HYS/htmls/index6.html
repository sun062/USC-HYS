<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brainlink ë°ì´í„° ì¦ê°ë¥  ë¶„ì„ê¸°</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€: XLSX íŒŒì¼ íŒŒì‹± ë° ë‹¤ìš´ë¡œë“œë¥¼ ìœ„í•´ ì‚¬ìš© -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Inter í°íŠ¸ ì„¤ì • */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .container {
            max-width: 1000px;
        }
        .file-input {
            border: 2px dashed #d1d5db;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .file-input:hover {
            border-color: #9ca3af;
            background-color: #f3f4f6;
        }
        .analysis-box {
            background-color: #fffbeb; /* Light yellow background for analysis */
            border: 1px solid #fde68a; /* Yellow border */
            color: #92400e; /* Brownish text */
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container mx-auto bg-white shadow-xl rounded-2xl p-6 md:p-10">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">
            ì¹´í˜ì¸ ì„­ì·¨ ì „í›„ ë°ì´í„° ì¦ê°ë¥  ë¶„ì„
        </h1>
        <p class="text-gray-600 mb-8 text-center">
            Brainlink í‰ê·  ë°ì´í„° íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ê° ì§€í‘œì˜ ì¦ê°ë¥ ì„ í™•ì¸í•˜ì„¸ìš”.
        </p>

        <!-- íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- 1. ì¹´í˜ì¸ ë¯¸ì„­ì·¨ (Before) -->
            <div class="bg-blue-50 p-6 rounded-xl border border-blue-200">
                <label for="fileNoCaffeine" class="block text-lg font-semibold text-blue-800 mb-3">
                    [1] ì¹´í˜ì¸ ë¯¸ì„­ì·¨ ë°ì´í„° (ê¸°ì¤€ê°’)
                </label>
                <div class="file-input rounded-xl" id="fileNoCaffeineContainer">
                    <input type="file" id="fileNoCaffeine" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" class="hidden" onchange="displayFileName('fileNoCaffeine', 'fileNameNoCaffeine')">
                    <p class="text-blue-600"><span id="fileNameNoCaffeine" class="font-medium text-gray-700">íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš” (.csv ë˜ëŠ” .xlsx)</span></p>
                    <p class="text-sm text-blue-500 mt-1">ì²« ë²ˆì§¸ í–‰ì€ í—¤ë”(íƒœê·¸, Attention ë“±)ì—¬ì•¼ í•©ë‹ˆë‹¤. Excel íŒŒì¼ì€ ì²« ë²ˆì§¸ ì‹œíŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
                </div>
            </div>

            <!-- 2. ì¹´í˜ì¸ ì„­ì·¨ (After) -->
            <div class="bg-green-50 p-6 rounded-xl border border-green-200">
                <label for="fileWithCaffeine" class="block text-lg font-semibold text-green-800 mb-3">
                    [2] ì¹´í˜ì¸ ì„­ì·¨ ë°ì´í„° (ë¹„êµê°’)
                </label>
                <div class="file-input rounded-xl" id="fileWithCaffeineContainer">
                    <input type="file" id="fileWithCaffeine" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" class="hidden" onchange="displayFileName('fileWithCaffeine', 'fileNameWithCaffeine')">
                    <p class="text-green-600"><span id="fileNameWithCaffeine" class="font-medium text-gray-700">íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš” (.csv ë˜ëŠ” .xlsx)</span></p>
                    <p class="text-sm text-green-500 mt-1">ë‘ íŒŒì¼ì˜ 'íƒœê·¸' í•­ëª©ì´ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>

        <!-- ë²„íŠ¼ ë° ìƒíƒœ ë©”ì‹œì§€ -->
        <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mb-8">
            <button id="runAnalysis" onclick="runAnalysis()"
                    class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.02] disabled:bg-indigo-300 disabled:cursor-not-allowed">
                ë¶„ì„ ì‹¤í–‰
            </button>
            <button id="downloadExcel" onclick="downloadXLSX()" disabled
                    class="w-full sm:w-auto px-6 py-3 bg-gray-400 text-white font-bold rounded-xl shadow-lg hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02] disabled:bg-gray-300 disabled:cursor-not-allowed">
                ê²°ê³¼ ë‹¤ìš´ë¡œë“œ (.xlsx)
            </button>
        </div>

        <div id="statusMessage" class="text-center p-3 rounded-lg font-semibold mt-4 hidden"></div>
        
        <!-- ì›ë³¸ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ (ìƒˆë¡œ ì¶”ê°€) -->
        <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6" id="rawDataPreviewSection">
            <!-- ì¹´í˜ì¸ ë¯¸ì„­ì·¨ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° -->
            <div id="dataNoCaffeine" class="hidden bg-gray-50 p-4 rounded-xl border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">ì›ë³¸ ë°ì´í„° [1] (ë¯¸ì„­ì·¨)</h3>
                <div id="dataNoCaffeineContent" class="text-xs overflow-x-auto"></div>
            </div>
            <!-- ì¹´í˜ì¸ ì„­ì·¨ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° -->
            <div id="dataWithCaffeine" class="hidden bg-gray-50 p-4 rounded-xl border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">ì›ë³¸ ë°ì´í„° [2] (ì„­ì·¨)</h3>
                <div id="dataWithCaffeineContent" class="text-xs overflow-x-auto"></div>
            </div>
        </div>


        <!-- ê²°ê³¼ ì„¹ì…˜ -->
        <div id="resultsSection" class="mt-10 hidden">
            
            <!-- ë¶„ì„ ìš”ì•½ -->
            <div id="analysisSummary" class="analysis-box p-5 rounded-xl shadow-md mb-8">
                <h2 class="text-xl font-bold text-gray-900 mb-3">ğŸ“Š ë¶„ì„ ìš”ì•½</h2>
                <div id="summaryContent" class="text-sm leading-relaxed">
                    <!-- ìš”ì•½ ë‚´ìš©ì´ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">ìƒì„¸ ì¦ê°ë¥  í…Œì´ë¸” (%)</h2>
            <div class="overflow-x-auto rounded-xl shadow-lg">
                <table id="resultsTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <!-- í—¤ë”ê°€ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- í…œí”Œë¦¿: ì‚¬ìš©ìì—ê²Œ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ëŠ” ë°©ë²•ì„ ë³´ì—¬ì£¼ëŠ” ì´ë¯¸ì§€ -->
        <div class="mt-8 pt-6 border-t border-gray-200 text-center">
            <p class="text-gray-500 text-sm">
                íŒŒì¼ í˜•ì‹ì´ ê¶ê¸ˆí•˜ë‹¤ë©´ ì˜ˆì‹œë¥¼ ì°¸ê³ í•˜ì„¸ìš”.
            </p>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let parsedData = null; // ë¶„ì„ëœ ê²°ê³¼ë¥¼ ì €ì¥í•  ë³€ìˆ˜

        // íŒŒì¼ ì…ë ¥ ì»¨í…Œì´ë„ˆ í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒì°½ ì—´ê¸°
        document.getElementById('fileNoCaffeineContainer').addEventListener('click', () => {
            document.getElementById('fileNoCaffeine').click();
        });
        document.getElementById('fileWithCaffeineContainer').addEventListener('click', () => {
            document.getElementById('fileWithCaffeine').click();
        });

        /**
         * íŒŒì¼ ì„ íƒ ì‹œ íŒŒì¼ ì´ë¦„ í‘œì‹œ
         * @param {string} inputId - file input ìš”ì†Œ ID
         * @param {string} nameSpanId - íŒŒì¼ ì´ë¦„ í‘œì‹œí•  span ID
         */
        function displayFileName(inputId, nameSpanId) {
            const input = document.getElementById(inputId);
            const nameSpan = document.getElementById(nameSpanId);
            if (input.files.length > 0) {
                nameSpan.textContent = `âœ… ${input.files[0].name}`;
            } else {
                nameSpan.textContent = 'íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš” (.csv ë˜ëŠ” .xlsx)';
            }
            // ë¶„ì„ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
            checkFilesReady();
        }

        /**
         * íŒŒì¼ ë‘ ê°œê°€ ëª¨ë‘ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸
         */
        function checkFilesReady() {
            const file1 = document.getElementById('fileNoCaffeine').files.length > 0;
            const file2 = document.getElementById('fileWithCaffeine').files.length > 0;
            document.getElementById('runAnalysis').disabled = !(file1 && file2);
        }

        /**
         * ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
         * @param {string} message - í‘œì‹œí•  ë©”ì‹œì§€
         * @param {string} type - 'success', 'error', 'info'
         */
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `text-center p-3 rounded-lg font-semibold mt-4`;
            statusDiv.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700');
            if (type === 'error') {
                statusDiv.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                statusDiv.classList.add('bg-green-100', 'text-green-700');
            } else {
                statusDiv.classList.add('bg-yellow-100', 'text-yellow-700');
            }
            // showStatusê°€ í˜¸ì¶œë  ë•Œë§ˆë‹¤ ê²°ê³¼ ì„¹ì…˜ì€ ìˆ¨ê²¨ì§‘ë‹ˆë‹¤. (ë¶„ì„ ì™„ë£Œ ì‹œ displayResultsì—ì„œ ë‹¤ì‹œ í‘œì‹œí•¨)
            document.getElementById('downloadExcel').disabled = true;
            document.getElementById('resultsSection').classList.add('hidden');
        }

        /**
         * CSV í…ìŠ¤íŠ¸ë¥¼ íŒŒì‹±í•˜ì—¬ ê°ì²´ ë°°ì—´ë¡œ ë³€í™˜ (ë”°ì˜´í‘œë¥¼ í¬í•¨í•˜ëŠ” í•„ë“œ ì§€ì›)
         * @param {string} csvText - CSV íŒŒì¼ì˜ í…ìŠ¤íŠ¸ ë‚´ìš©
         * @returns {Array<Object>} íŒŒì‹±ëœ ë°ì´í„° ê°ì²´ ë°°ì—´
         */
        function parseCSV(csvText) {
            // ë”°ì˜´í‘œë¡œ ë¬¶ì¸ í•„ë“œ ë‚´ì˜ ì½¤ë§ˆë¥¼ ë¬´ì‹œí•˜ê³  ì½¤ë§ˆë¡œ ë¶„ë¦¬í•˜ëŠ” ì •ê·œì‹.
            // ì‰¼í‘œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¦¬í•˜ë˜, ì§ìˆ˜ ê°œì˜ ë”°ì˜´í‘œ ì‚¬ì´ì— ìˆëŠ” ì‰¼í‘œëŠ” ë¬´ì‹œí•©ë‹ˆë‹¤.
            const separatorRegex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;

            // BOM ë¬¸ì ì œê±° (íŠ¹íˆ UTF-8 CSV íŒŒì¼ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆìŒ)
            let cleanedCsvText = csvText;
            if (cleanedCsvText.startsWith('\ufeff')) {
                cleanedCsvText = cleanedCsvText.substring(1);
            }

            // CSV í…ìŠ¤íŠ¸ë¥¼ ì¤„ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•˜ê³ , ë¹ˆ ì¤„ ë° ê³µë°±ë§Œ ìˆëŠ” ì¤„ ì œê±°
            const lines = cleanedCsvText.trim().split(/\r?\n/).filter(line => line.trim() !== '');
            if (lines.length < 2) throw new Error("íŒŒì¼ì— í—¤ë”ì™€ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");

            // 1. í—¤ë” ì¶”ì¶œ ë° ì •ë¦¬ (ê°€ì¥ ê°•ë ¥í•œ ë¬¸ìì—´ ì •ë¦¬)
            let headerLine = lines[0].trim();
            
            // ì •ê·œì‹ì„ ì‚¬ìš©í•˜ì—¬ í—¤ë” ë¼ì¸ì„ ë¶„ë¦¬
            const headers = headerLine.split(separatorRegex).map(h => {
                // ê° í—¤ë” í•­ëª©ì—ì„œ ë¶ˆí•„ìš”í•œ ë”°ì˜´í‘œì™€ ì•ë’¤ ê³µë°±ì„ ê°•ë ¥í•˜ê²Œ ì œê±°í•˜ê³ ,
                // ëˆˆì— ë³´ì´ì§€ ì•ŠëŠ” ì œì–´ ë¬¸ì (Control characters)ë„ ëª¨ë‘ ì œê±°
                return h.trim()
                        .replace(/^"|"$/g, '') // ì•ë’¤ ë”°ì˜´í‘œ ì œê±°
                        .replace(/[\u0000-\u001F\u007F-\u009F]/g, '') // ì œì–´ ë¬¸ì ì œê±°
                        .trim(); // ìµœì¢… ê³µë°± ì œê±°
            });
            
            // ìœ íš¨í•˜ì§€ ì•Šì€ í—¤ë” ì œê±° (ë¹„ì–´ìˆëŠ” ì»¬ëŸ¼ ë°©ì§€)
            const validHeaders = headers.filter(h => h.length > 0);
            if (validHeaders.length === 0) {
                 throw new Error("í—¤ë”(ì œëª© í–‰)ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
            
            const data = [];

            // 2. ë°ì´í„° í–‰ íŒŒì‹±
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // ì •ê·œì‹ì„ ì‚¬ìš©í•˜ì—¬ ë¼ì¸ì„ ê°’ìœ¼ë¡œ ë¶„ë¦¬
                const values = line.split(separatorRegex);

                // ë¶ˆí•„ìš”í•œ ë”°ì˜´í‘œ ì œê±° ë° ê³µë°± ì œê±°
                const cleanedValues = values.map(v => v.trim().replace(/^"|"$/g, '').trim());

                // í—¤ë” ê°œìˆ˜ì™€ ê°’ì˜ ê°œìˆ˜ê°€ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ê±´ë„ˆë›°ê¸°
                if (cleanedValues.length !== validHeaders.length) {
                    console.warn(`í–‰ ${i + 1}: ì˜ˆìƒëœ ì»¬ëŸ¼ ìˆ˜ (${validHeaders.length})ì™€ ì‹¤ì œ ì»¬ëŸ¼ ìˆ˜ (${cleanedValues.length})ê°€ ì¼ì¹˜í•˜ì§€ ì•Šì•„ ê±´ë„ˆëœë‹ˆë‹¤. (ì›ë³¸ í–‰: ${line})`);
                    continue;
                }

                const row = {};
                for (let j = 0; j < validHeaders.length; j++) {
                    const header = validHeaders[j];
                    let value = cleanedValues[j];

                    // ì²« ë²ˆì§¸ í—¤ë” (íƒœê·¸)ëŠ” ë¬¸ìì—´ë¡œ ìœ ì§€
                    // ê°’ì´ ë¹„ì–´ìˆì§€ ì•Šê³ , ìˆ«ìë¡œ ë³€í™˜ ê°€ëŠ¥í•  ë•Œë§Œ ìˆ«ìí˜•ìœ¼ë¡œ ë³€í™˜
                    if (j > 0 && value !== "" && !isNaN(parseFloat(value)) && isFinite(value)) {
                        row[header] = parseFloat(value);
                    } else {
                        // íƒœê·¸ ë˜ëŠ” ë¹„-ìˆ«ì ë°ì´í„°ëŠ” ë¬¸ìì—´ë¡œ ìœ ì§€
                        row[header] = value;
                    }
                }
                data.push(row);
            }
            
            if (data.length === 0) {
                 throw new Error("íŒŒì‹± í›„ ìœ íš¨í•œ ë°ì´í„° í–‰ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. íŒŒì¼ ë‚´ìš©ì´ ë¹„ì–´ìˆê±°ë‚˜, ë°ì´í„° í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            }

            return data;
        }

        /**
         * ë¹„ë™ê¸° íŒŒì¼ ì½ê¸° ë° CSV í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ (XLSX ì§€ì› í¬í•¨)
         * @param {File} file - ì½ì„ íŒŒì¼ ê°ì²´
         * @returns {Promise<string>} íŒŒì¼ ë‚´ìš©(í…ìŠ¤íŠ¸)ì„ í¬í•¨í•˜ëŠ” Promise (CSV í˜•ì‹)
         */
        function readFileAsync(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                const fileName = file.name.toLowerCase();

                if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                    // XLSX íŒŒì¼ ì²˜ë¦¬ (ArrayBufferë¡œ ì½ê¸°)
                    reader.onload = (event) => {
                        try {
                            if (typeof XLSX === 'undefined') {
                                reject(new Error("XLSX íŒŒì‹± ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”."));
                                return;
                            }
                            const data = new Uint8Array(event.target.result);
                            // XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì›Œí¬ë¶ ì½ê¸°
                            const workbook = XLSX.read(data, { type: 'array' });
                            // ì²« ë²ˆì§¸ ì‹œíŠ¸ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            // ì‹œíŠ¸ ë°ì´í„°ë¥¼ CSV í˜•ì‹ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
                            // FS: í•„ë“œ êµ¬ë¶„ì (Comma), RS: í–‰ êµ¬ë¶„ì (Newline)
                            const csvText = XLSX.utils.sheet_to_csv(worksheet, { FS: ',', RS: '\n' });
                            resolve(csvText);
                        } catch (e) {
                            reject(new Error(`XLSX íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜: ${e.message}. íŒŒì¼ì´ ì†ìƒë˜ì—ˆê±°ë‚˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì€ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`));
                        }
                    };
                    reader.onerror = (error) => reject(error);
                    reader.readAsArrayBuffer(file);
                } else if (fileName.endsWith('.csv')) {
                    // CSV íŒŒì¼ ì²˜ë¦¬ (Textë¡œ ì½ê¸°)
                    reader.onload = (event) => resolve(event.target.result);
                    reader.onerror = (error) => reject(error);
                    // ëŒ€ë¶€ë¶„ì˜ ìµœì‹  ë¸Œë¼ìš°ì €ëŠ” UTF-8ì„ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
                    reader.readAsText(file); 
                } else {
                    reject(new Error("ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. .csv ë˜ëŠ” .xlsx íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”."));
                }
            });
        }

        /**
         * ë‘ ë°ì´í„°ì…‹ì„ ë¶„ì„í•˜ì—¬ ì¦ê°ë¥  ê³„ì‚°
         * @param {Array<Object>} dataNoCaffeine - ì¹´í˜ì¸ ë¯¸ì„­ì·¨ ë°ì´í„°
         * @param {Array<Object>} dataWithCaffeine - ì¹´í˜ì¸ ì„­ì·¨ ë°ì´í„°
         * @returns {{results: Array<Object>, metrics: Array<string>, tagHeader: string, overallAverage: number, attentionAverage: number, relaxationAverage: number}} ë¶„ì„ ê²°ê³¼ ê°ì²´
         */
        function calculateChangeRate(dataNoCaffeine, dataWithCaffeine) {
            if (dataNoCaffeine.length === 0 || dataWithCaffeine.length === 0) {
                throw new Error("ì—…ë¡œë“œëœ íŒŒì¼ì— ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            }

            // í—¤ë” í™•ì¸ ë° íƒœê·¸ í—¤ë” ì‹ë³„
            const headerKeysNo = Object.keys(dataNoCaffeine[0]);
            const tagHeader = headerKeysNo[0]; // ì²« ë²ˆì§¸ ì»¬ëŸ¼ì„ íƒœê·¸ë¡œ ê°€ì •

            if (!tagHeader.includes('íƒœê·¸') && !tagHeader.toLowerCase().includes('tag')) {
                // ê°•ë ¥í•œ ì—ëŸ¬ ì²˜ë¦¬ ëŒ€ì‹  ê²½ê³ ë§Œ í‘œì‹œí•˜ê³  ë‹¤ìŒìœ¼ë¡œ ì§„í–‰
                console.warn(`ê²½ê³ : ì²« ë²ˆì§¸ ì»¬ëŸ¼(${tagHeader})ì´ 'íƒœê·¸(Tag)' í•­ëª©ì´ ì•„ë‹Œ ê²ƒ ê°™ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ì»¬ëŸ¼ì„ ê¸°ì¤€ìœ¼ë¡œ ë¶„ì„ì„ ê³„ì†í•©ë‹ˆë‹¤.`);
            }

            // ë¹„êµë¥¼ ìœ„í•œ ê¸°ì¤€ ë°ì´í„° ë§µ ìƒì„± (íƒœê·¸ë¥¼ í‚¤ë¡œ ì‚¬ìš©)
            const mapNoCaffeine = new Map();
            dataNoCaffeine.forEach(row => {
                mapNoCaffeine.set(row[tagHeader], row);
            });

            const results = [];
            const metrics = [];
            let totalRateSum = 0;
            let totalRateCount = 0;
            let attentionRateSum = 0;
            let attentionRateCount = 0;
            let relaxationRateSum = 0;
            let relaxationRateCount = 0;
            
            // Brainlink ë°ì´í„°ì—ì„œ ì§‘ì¤‘ë„(Attention)ì™€ ì´ì™„ë„(Relaxation)ë¥¼ ë‚˜íƒ€ë‚´ëŠ” í‚¤ ì‹ë³„
            // ì‚¬ìš©ìì˜ íŒŒì¼ í—¤ë” í˜•ì‹ê³¼ ì¼ì¹˜í•˜ë„ë¡ ëª¨ë“  ì¡°í•©ì„ ê³ ë ¤
            const ATTENTION_KEYS = ['Attention/æ³¨æ„åŠ›', 'Attention', 'æ³¨æ„åŠ›'];
            const RELAXATION_KEYS = ['Relaxation/æ”¾æ¾åº¦', 'Relaxation', 'æ”¾æ¾åº¦'];

            dataWithCaffeine.forEach(rowWith => {
                const tag = rowWith[tagHeader];
                const rowNo = mapNoCaffeine.get(tag);

                if (!rowNo) {
                    // ë¯¸ì„­ì·¨ ë°ì´í„°ì— íƒœê·¸ê°€ ì—†ëŠ” ê²½ìš° ê±´ë„ˆë›°ê¸°
                    // console.warn(`ë¯¸ì„­ì·¨ ë°ì´í„°ì—ì„œ íƒœê·¸ '${tag}'ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•´ë‹¹ í•­ëª©ì€ ë¶„ì„ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.`);
                    return;
                }

                const resultRow = { [tagHeader]: tag };

                // ì²« ë²ˆì§¸ ì»¬ëŸ¼(íƒœê·¸)ì„ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ì»¬ëŸ¼ë“¤ì— ëŒ€í•´ ê³„ì‚°
                Object.keys(rowWith).forEach((key, index) => {
                    if (index === 0) return; // ì²« ë²ˆì§¸ íƒœê·¸ ì»¬ëŸ¼ì€ ê±´ë„ˆë›°ê¸°

                    if (metrics.indexOf(key) === -1) {
                        metrics.push(key);
                    }

                    const valWith = rowWith[key];
                    const valNo = rowNo[key];

                    // ìˆ«ìí˜• ë°ì´í„°ì¸ì§€ í™•ì¸
                    if (typeof valWith === 'number' && typeof valNo === 'number') {
                        let rate = 0;
                        if (valNo !== 0) {
                            // ì¦ê°ë¥  (%) = (ì„­ì·¨ ê°’ - ë¯¸ì„­ì·¨ ê°’) / ë¯¸ì„­ì·¨ ê°’ * 100
                            rate = ((valWith - valNo) / valNo) * 100;
                        } else if (valWith !== 0) {
                            // ë¯¸ì„­ì·¨ ê°’ì´ 0ì´ê³  ì„­ì·¨ ê°’ì´ 0ì´ ì•„ë‹ˆë©´ ë¬´í•œëŒ€ ì¦ê°€ë¡œ ê°„ì£¼
                            rate = 99999.99;
                        } else {
                            // ë‘˜ ë‹¤ 0ì´ë©´ 0% (ë³€í™” ì—†ìŒ)
                            rate = 0;
                        }
                        
                        const finalRate = parseFloat(rate.toFixed(2));
                        resultRow[key] = finalRate; // ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬ê¹Œì§€ ë°˜ì˜¬ë¦¼

                        // ì „ì²´ í‰ê·  ê³„ì‚°ì„ ìœ„í•œ ëˆ„ì 
                        totalRateSum += finalRate;
                        totalRateCount++;

                        // ì£¼ìš” ì§€í‘œ í‰ê·  ê³„ì‚°ì„ ìœ„í•œ ëˆ„ì 
                        if (ATTENTION_KEYS.includes(key)) {
                            attentionRateSum += finalRate;
                            attentionRateCount++;
                        } else if (RELAXATION_KEYS.includes(key)) {
                            relaxationRateSum += finalRate;
                            relaxationRateCount++;
                        }

                    } else {
                        // ìˆ«ìê°€ ì•„ë‹Œ ë°ì´í„°ëŠ” ë¶„ì„ì—ì„œ ì œì™¸ (ë¹ˆ ë¬¸ìì—´ ì²˜ë¦¬)
                        resultRow[key] = "";
                    }
                });
                results.push(resultRow);
            });

            // ì „ì²´/ì£¼ìš” ì§€í‘œì˜ í‰ê·  ì¦ê°ë¥  ê³„ì‚°
            const overallAverage = totalRateCount > 0 ? parseFloat((totalRateSum / totalRateCount).toFixed(2)) : 0;
            const attentionAverage = attentionRateCount > 0 ? parseFloat((attentionRateSum / attentionRateCount).toFixed(2)) : 0;
            const relaxationAverage = relaxationRateCount > 0 ? parseFloat((relaxationRateSum / relaxationRateCount).toFixed(2)) : 0;


            return { results, metrics, tagHeader, overallAverage, attentionAverage, relaxationAverage };
        }

        /**
         * ì›ë³¸ ë°ì´í„°ë¥¼ HTML í…Œì´ë¸”ë¡œ ë³€í™˜í•˜ì—¬ í‘œì‹œ (ìµœëŒ€ 10í–‰)
         * @param {string} containerId - ë°ì´í„°ë¥¼ í‘œì‹œí•  ì»¨í…Œì´ë„ˆ divì˜ ID (e.g., 'dataNoCaffeineContent')
         * @param {Array<Object>} data - íŒŒì‹±ëœ ë°ì´í„° ë°°ì—´
         * @param {string} fileName - íŒŒì¼ ì´ë¦„
         */
        function displayRawData(containerId, data, fileName) {
            const container = document.getElementById(containerId);
            if (!data || data.length === 0) {
                container.innerHTML = `<p class="text-red-500">íŒŒì¼ "${fileName}"ì—ì„œ ìœ íš¨í•œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
                // ë¶€ëª¨ ì»¨í…Œì´ë„ˆ í‘œì‹œ ë¡œì§ ìˆ˜ì •: dataNoCaffeineContent -> dataNoCaffeine
                const parentId = containerId.replace('Content', '');
                const parentElement = document.getElementById(parentId);
                if (parentElement) {
                    parentElement.classList.remove('hidden');
                } else {
                    console.error(`Parent element with ID '${parentId}' not found.`);
                }
                return;
            }

            const maxRows = 10;
            const headers = Object.keys(data[0]);

            // í…Œì´ë¸” ì‹œì‘
            let tableHtml = `
                <p class="text-gray-500 mb-2 font-medium">íŒŒì¼ëª…: ${fileName} (ì´ ${data.length}ê°œ í•­ëª©, ìƒìœ„ ${Math.min(data.length, maxRows)}í–‰ í‘œì‹œ)</p>
                <div class="overflow-x-auto border rounded">
                    <table class="w-full text-left whitespace-nowrap divide-y divide-gray-300">
                        <thead class="bg-gray-200">
                            <tr>
                                ${headers.map(h => `<th class="px-2 py-1 font-bold text-gray-800 text-xs">${h.split('/')[0]}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;

            // ë°ì´í„° í–‰ (ìµœëŒ€ 10ê°œ)
            for (let i = 0; i < Math.min(data.length, maxRows); i++) {
                const row = data[i];
                tableHtml += `<tr>`;
                headers.forEach(header => {
                    let value = row[header];
                    let cellClass = 'text-gray-700';
                    
                    // ìˆ«ìëŠ” ì˜¤ë¥¸ìª½ ì •ë ¬
                    if (typeof value === 'number') {
                        value = value.toLocaleString(undefined, { maximumFractionDigits: 4 });
                        cellClass = 'text-right text-gray-900 font-mono';
                    }
                    
                    tableHtml += `<td class="px-2 py-1 border-t border-gray-300 ${cellClass} text-xs">${value}</td>`;
                });
                tableHtml += `</tr>`;
            }

            // í…Œì´ë¸” ë
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHtml;
            // ë¶€ëª¨ ì»¨í…Œì´ë„ˆ í‘œì‹œ
            document.getElementById(containerId.replace('Content', '')).classList.remove('hidden');
        }

        /**
         * ë¶„ì„ ê²°ê³¼ë¥¼ HTML í…Œì´ë¸”ì— í‘œì‹œ
         * @param {Object} analysisResult - calculateChangeRate í•¨ìˆ˜ì—ì„œ ë°˜í™˜ëœ ê²°ê³¼ ê°ì²´
         */
        function displayResults(analysisResult) {
            const { results, metrics, tagHeader } = analysisResult;
            const tableHead = document.querySelector('#resultsTable thead');
            const tableBody = document.querySelector('#resultsTable tbody');

            // 1. í—¤ë” ìƒì„±
            let headerHtml = '<tr>';
            headerHtml += `<th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-100">${tagHeader}</th>`; // íƒœê·¸ ì»¬ëŸ¼
            metrics.forEach(metric => {
                // ì»¬ëŸ¼ ì œëª©ì„ / ê¸°ì¤€ìœ¼ë¡œ ì²« ë²ˆì§¸ ë¶€ë¶„ë§Œ ì‚¬ìš© (ì˜ˆ: Attention/æ³¨æ„åŠ› -> Attention)
                headerHtml += `<th class="px-6 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">${metric.split('/')[0]} (%)</th>`;
            });
            headerHtml += '</tr>';
            tableHead.innerHTML = headerHtml;

            // 2. ë³¸ë¬¸ ë°ì´í„° ìƒì„±
            let bodyHtml = '';
            results.forEach(row => {
                bodyHtml += '<tr>';
                // íƒœê·¸ ì»¬ëŸ¼
                bodyHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 bg-white">${row[tagHeader]}</td>`;

                // ë©”íŠ¸ë¦­ ì»¬ëŸ¼
                metrics.forEach(metric => {
                    const value = row[metric];
                    let cellClass = 'text-gray-900';
                    let displayValue = value;

                    if (typeof value === 'number') {
                        if (value === 99999.99) {
                            // ë¬´í•œëŒ€ ì¦ê°€ ì²˜ë¦¬
                            cellClass = 'text-red-800 font-extrabold';
                            displayValue = `+âˆ (Zero Base)`;
                        } else if (value > 0) {
                            cellClass = 'text-red-600 font-semibold'; // ì¦ê°€: ë¹¨ê°„ìƒ‰
                            displayValue = `+${value.toLocaleString()}`;
                        } else if (value < 0) {
                            cellClass = 'text-blue-600 font-semibold'; // ê°ì†Œ: íŒŒë€ìƒ‰
                            displayValue = value.toLocaleString();
                        } else {
                            displayValue = '0.00';
                        }
                    } else if (value === "") {
                         displayValue = 'N/A';
                    }

                    bodyHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-center ${cellClass}">${displayValue}</td>`;
                });
                bodyHtml += '</tr>';
            });
            tableBody.innerHTML = bodyHtml;

            // 3. ë¶„ì„ ìš”ì•½ ìƒì„± ë° í‘œì‹œ
            displayAnalysisSummary(analysisResult);

            // 4. ì„¹ì…˜ í‘œì‹œ
            document.getElementById('resultsSection').classList.remove('hidden');
            
            // ì™„ë£Œ ë©”ì‹œì§€ ëª…í™•í™” ë° ìë™ ìŠ¤í¬ë¡¤
            showStatus(`âœ… ë¶„ì„ ì™„ë£Œ! ì•„ë˜ ë¶„ì„ ìš”ì•½ê³¼ ìƒì„¸ í…Œì´ë¸”ì—ì„œ ì¦ê°ë¥ ì„ í™•ì¸í•´ì£¼ì„¸ìš”. (ì´ ${results.length}ê°œ íƒœê·¸)`, 'success');
            document.getElementById('downloadExcel').disabled = false;
            
            // ê²°ê³¼ ì„¹ì…˜ìœ¼ë¡œ í™”ë©´ì„ ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤í•˜ì—¬ ì‚¬ìš©ìì—ê²Œ í‘œì‹œ
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        /**
         * ë¶„ì„ ìš”ì•½ì„ ìƒì„±í•˜ê³  í‘œì‹œ
         * @param {Object} analysisResult - calculateChangeRate í•¨ìˆ˜ì—ì„œ ë°˜í™˜ëœ ê²°ê³¼ ê°ì²´
         */
        function displayAnalysisSummary(analysisResult) {
            const { overallAverage, attentionAverage, relaxationAverage } = analysisResult;
            const summaryDiv = document.getElementById('summaryContent');
            
            // Helper function for coloring and formatting
            const formatRate = (rate) => {
                const color = rate > 0 ? 'text-red-600' : (rate < 0 ? 'text-blue-600' : 'text-gray-800');
                const sign = rate > 0 ? '+' : '';
                return `<span class="font-extrabold ${color}">${sign}${rate.toFixed(2)}%</span>`;
            };

            // 1. ì „ì²´ í‰ê·  ë³€í™” ë¶„ì„
            let overallText = `ì „ì²´ í‰ê·  ì¦ê°ë¥ : ${formatRate(overallAverage)} ì…ë‹ˆë‹¤.`;
            overallText += overallAverage > 0 
                ? " ì¹´í˜ì¸ ì„­ì·¨ í›„ ì „ë°˜ì ì¸ ë‡ŒíŒŒ ì§€í‘œê°€ **ì¦ê°€**í•˜ëŠ” ê²½í–¥ì„ ë³´ì˜€ìŠµë‹ˆë‹¤."
                : (overallAverage < 0 
                    ? " ì¹´í˜ì¸ ì„­ì·¨ í›„ ì „ë°˜ì ì¸ ë‡ŒíŒŒ ì§€í‘œê°€ **ê°ì†Œ**í•˜ëŠ” ê²½í–¥ì„ ë³´ì˜€ìŠµë‹ˆë‹¤."
                    : " ì¹´í˜ì¸ ì„­ì·¨ ì „í›„ë¡œ ì „ë°˜ì ì¸ ë‡ŒíŒŒ ì§€í‘œì˜ ë³€í™”ëŠ” ê±°ì˜ ì—†ì—ˆìŠµë‹ˆë‹¤.");

            // 2. Attention ë³€í™” ë¶„ì„
            let attentionText = `Attention(ì§‘ì¤‘ë„) í‰ê·  ë³€í™”ìœ¨: ${formatRate(attentionAverage)}`;
            attentionText += attentionAverage > 0
                ? "ë¡œ **ì§‘ì¤‘ë„ê°€ í–¥ìƒ**ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ëŠ” ì¹´í˜ì¸ì˜ ëŒ€í‘œì ì¸ ê°ì„± íš¨ê³¼ì™€ ì¼ì¹˜í•©ë‹ˆë‹¤."
                : (attentionAverage < 0
                    ? "ë¡œ **ì§‘ì¤‘ë„ê°€ ì†Œí­ ê°ì†Œ**í–ˆìŠµë‹ˆë‹¤. ì´ëŠ” ë°ì´í„° ì§‘ë‹¨ì— ë”°ë¼ ì¹´í˜ì¸ì˜ ì˜í–¥ì´ ë‹¤ë¥´ê±°ë‚˜ í”¼ë¡œ ëˆ„ì  ë“±ì˜ ë‹¤ë¥¸ ìš”ì¸ì´ ì‘ìš©í•œ ê²ƒì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
                    : "ë¡œ ë³€í™”ê°€ ë¯¸ë¯¸í–ˆìŠµë‹ˆë‹¤.");

            // 3. Relaxation ë³€í™” ë¶„ì„
            let relaxationText = `Relaxation(ì´ì™„ë„) í‰ê·  ë³€í™”ìœ¨: ${formatRate(relaxationAverage)}`;
            relaxationText += relaxationAverage < 0
                ? "ë¡œ **ì´ì™„ë„ê°€ ê°ì†Œ**í–ˆìŠµë‹ˆë‹¤. ì´ëŠ” ì§‘ì¤‘ë„ ì¦ê°€ì™€ í•¨ê»˜ ì¹´í˜ì¸ì´ ë‡Œë¥¼ ê°ì„± ìƒíƒœë¡œ ì „í™˜ì‹œì¼°ìŒì„ ì‹œì‚¬í•©ë‹ˆë‹¤."
                : (relaxationAverage > 0
                    ? "ë¡œ **ì´ì™„ë„ê°€ ì¦ê°€**í–ˆìŠµë‹ˆë‹¤. ì´ëŠ” ì˜ì™¸ì˜ ê²°ê³¼ì¼ ìˆ˜ ìˆìœ¼ë©°, ê°œì¸ì´ ì¹´í˜ì¸ì„ í†µí•´ ì˜¤íˆë ¤ ì•ˆì •ê°ì„ ëŠë¼ê±°ë‚˜ ì¸¡ì • ì´ˆë°˜ë¶€ì— ì´ì™„ë„ê°€ ë†’ê²Œ ë‚˜íƒ€ë‚¬ì„ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤."
                    : "ë¡œ ë³€í™”ê°€ ë¯¸ë¯¸í–ˆìŠµë‹ˆë‹¤.");


            // ìµœì¢… ìš”ì•½ ë‚´ìš© êµ¬ì„±
            summaryDiv.innerHTML = `
                <p class="mb-2"><strong>1. ì „ì²´ ì§€í‘œ í‰ê·  ë³€í™”:</strong> ${overallText}</p>
                <p class="mb-2"><strong>2. ì£¼ìš” ì§€í‘œ (Attention):</strong> ${attentionText}</p>
                <p><strong>3. ì£¼ìš” ì§€í‘œ (Relaxation):</strong> ${relaxationText}</p>
                <p class="mt-4 text-xs text-gray-600">*ìœ„ ë¶„ì„ì€ ë‹¨ìˆœ í‰ê·  ë³€í™”ìœ¨ì„ ë°”íƒ•ìœ¼ë¡œ í•œ ìš”ì•½ì…ë‹ˆë‹¤. ë³´ë‹¤ ì •í™•í•œ íŒë‹¨ì„ ìœ„í•´ ìƒì„¸ í…Œì´ë¸”ì„ ì°¸ê³ í•˜ì‹œê³  í†µê³„ì  ìœ ì˜ì„±ì„ ê²€í† í•´ì•¼ í•©ë‹ˆë‹¤.</p>
            `;
        }


        /**
         * ë¶„ì„ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰
         */
        async function runAnalysis() {
            const fileNoCaffeine = document.getElementById('fileNoCaffeine').files[0];
            const fileWithCaffeine = document.getElementById('fileWithCaffeine').files[0];

            if (!fileNoCaffeine || !fileWithCaffeine) {
                showStatus('ë‘ íŒŒì¼ ëª¨ë‘ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì›ë³¸ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ ìˆ¨ê¸°ê¸° (ID ìˆ˜ì • ë°˜ì˜)
            document.getElementById('dataNoCaffeine').classList.add('hidden');
            document.getElementById('dataWithCaffeine').classList.add('hidden');


            showStatus('íŒŒì¼ ì½ê¸° ë° ë¶„ì„ ì¤‘...', 'info');
            document.getElementById('runAnalysis').disabled = true;
            document.getElementById('downloadExcel').disabled = true;

            try {
                // 1. íŒŒì¼ ë‚´ìš© ì½ê¸° (XLSX/CSV ìë™ ê°ì§€ ë° CSV í…ìŠ¤íŠ¸ë¡œ ë³€í™˜)
                const textNo = await readFileAsync(fileNoCaffeine);
                const textWith = await readFileAsync(fileWithCaffeine);

                // 2. CSV íŒŒì‹±
                const dataNo = parseCSV(textNo);
                const dataWith = parseCSV(textWith);
                
                // 3. ì›ë³¸ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                displayRawData('dataNoCaffeineContent', dataNo, fileNoCaffeine.name);
                displayRawData('dataWithCaffeineContent', dataWith, fileWithCaffeine.name);


                // 4. ì¦ê°ë¥  ê³„ì‚°
                parsedData = calculateChangeRate(dataNo, dataWith);

                // 5. ê²°ê³¼ í‘œì‹œ
                displayResults(parsedData);

            } catch (error) {
                // ì‚¬ìš©ìì—ê²Œ êµ¬ì²´ì ì¸ ì˜¤ë¥˜ ì›ì¸ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
                console.error("ë¶„ì„ ì¤‘ ìµœì¢… ì˜¤ë¥˜:", error);
                showStatus(`ë¶„ì„ ì˜¤ë¥˜ ë°œìƒ: ${error.message}. íŒŒì¼ í˜•ì‹ ë° ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`, 'error');
            } finally {
                document.getElementById('runAnalysis').disabled = false;
            }
        }

        /**
         * ê²°ê³¼ë¥¼ XLSX íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ (CSVì—ì„œ ë³€ê²½ë¨)
         */
        function downloadXLSX() {
            if (!parsedData || parsedData.results.length === 0) {
                showStatus('ë‹¤ìš´ë¡œë“œí•  ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const { results, metrics, tagHeader } = parsedData;

            // SheetJSë¥¼ ìœ„í•œ ë°ì´í„° ì¤€ë¹„
            const exportData = results.map(row => {
                const newRow = {};
                newRow[tagHeader] = row[tagHeader];
                metrics.forEach(metric => {
                    // Excel í—¤ë”ëŠ” ê¹¨ë—í•œ ì´ë¦„ê³¼ ë‹¨ìœ„ë¥¼ ì‚¬ìš©
                    const cleanMetric = metric.split('/')[0] + ' (%)'; 
                    
                    let value = row[metric];

                    // íŠ¹ìˆ˜ ê°’ ì²˜ë¦¬ (Excelì—ì„œ ë³´ê¸° ì¢‹ê²Œ ë¬¸ìì—´ë¡œ ë³€í™˜)
                    if (value === 99999.99) {
                        value = '+âˆ (Zero Base)';
                    } else if (typeof value === 'number') {
                        // ì–‘ìˆ˜ì— '+'ë¥¼ ë¶™ì—¬ì„œ í‘œì‹œí•˜ê³ , ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬ê¹Œì§€ ìœ ì§€
                        value = value > 0 ? `+${value.toFixed(2)}` : value.toFixed(2);
                    } else if (value === "") {
                        value = 'N/A';
                    }
                    
                    newRow[cleanMetric] = value;
                });
                return newRow;
            });

            // 1. ìƒˆ ì›Œí¬ë¶ ìƒì„±
            const wb = XLSX.utils.book_new();
            
            // 2. JSON ë°ì´í„°ë¥¼ ì›Œí¬ì‹œíŠ¸ë¡œ ë³€í™˜
            const ws = XLSX.utils.json_to_sheet(exportData);
            
            // 3. ì›Œí¬ì‹œíŠ¸ë¥¼ ì›Œí¬ë¶ì— ì¶”ê°€
            XLSX.utils.book_append_sheet(wb, ws, "ChangeRateAnalysis");
            
            // 4. XLSX íŒŒì¼ë¡œ ì‘ì„± ë° ë‹¤ìš´ë¡œë“œ
            XLSX.writeFile(wb, 'Brainlink_Caffeine_Change_Rate_Analysis.xlsx');

            showStatus('ë¶„ì„ ê²°ê³¼ê°€ ì„±ê³µì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. (.xlsx)', 'success');
        }

    </script>
</body>
</html>
